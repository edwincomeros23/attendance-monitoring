<?php
// Prevent any output before JSON
ob_start();

session_start();
header('Content-Type: application/json');

// Set error handling
ini_set('display_errors', 0);
ini_set('log_errors', 1);
error_reporting(E_ALL);

set_error_handler(function($errno, $errstr, $errfile, $errline) {
    ob_end_clean();
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => 'Error: ' . $errstr . ' in ' . basename($errfile) . ':' . $errline]);
    exit;
});

set_exception_handler(function($e) {
    ob_end_clean();
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => 'Exception: ' . $e->getMessage()]);
    exit;
});

// Catch fatal errors
register_shutdown_function(function() {
    $error = error_get_last();
    if ($error && ($error['type'] === E_ERROR || $error['type'] === E_PARSE || $error['type'] === E_COMPILE_ERROR)) {
        ob_end_clean();
        http_response_code(500);
        echo json_encode(['success' => false, 'error' => 'Fatal: ' . $error['message'] . ' in ' . basename($error['file']) . ':' . $error['line']]);
        exit;
    }
});

require_once __DIR__ . '/../db.php';

if (!isset($conn)) {
    echo json_encode(['success' => false, 'error' => 'Database connection failed']);
    exit;
}

$action = $_POST['action'] ?? $_GET['action'] ?? '';

switch ($action) {
    case 'list':
        listCurriculum();
        break;
    case 'add':
        addCurriculum();
        break;
    case 'update':
        updateCurriculum();
        break;
    case 'delete':
        deleteCurriculum();
        break;
    case 'get_teachers':
        getTeachers();
        break;
    case 'check_conflict':
        checkConflict();
        break;
    default:
        echo json_encode(['success' => false, 'error' => 'Invalid action']);
}

function listCurriculum() {
    global $conn;
    ob_end_clean();
    
    $gradeLevel = $_GET['grade_level'] ?? '';
    $section = $_GET['section'] ?? '';
    
    $sql = "SELECT c.*, 
            CONCAT(t.first_name, ' ', IFNULL(CONCAT(t.middle_initial, '. '), ''), t.last_name) as teacher_name,
            t.faculty_id
            FROM curriculum c
            LEFT JOIN teachers t ON c.teacher_id = t.id";
    
    $conditions = [];
    $params = [];
    $types = '';
    
    if ($gradeLevel) {
        $conditions[] = "(c.grade_level = ? OR c.grade_level = ?)";
        $params[] = $gradeLevel;
        $params[] = "Grade " . $gradeLevel;
        $types .= 'ss';
    }
    
    if ($section) {
        $conditions[] = "(c.section = ? OR c.section IS NULL)";
        $params[] = $section;
        $types .= 's';
    }
    
    if (!empty($conditions)) {
        $sql .= " WHERE " . implode(' AND ', $conditions);
    }
    
    $sql .= " ORDER BY c.grade_level, c.subject_name";
    
    $stmt = $conn->prepare($sql);
    if (!empty($params)) {
        $stmt->bind_param($types, ...$params);
    }
    $stmt->execute();
    $result = $stmt->get_result();
    
    $data = [];
    while ($row = $result->fetch_assoc()) {
        $data[] = $row;
    }
    
    echo json_encode(['success' => true, 'data' => $data]);
}

function addCurriculum() {
    global $conn;
    ob_end_clean();
    
    $subject_code = trim($_POST['subject_code'] ?? '');
    $subject_name = trim($_POST['subject_name'] ?? '');
    $grade_level = trim($_POST['grade_level'] ?? '');
    $section = trim($_POST['section'] ?? '');
    $teacher_id = !empty($_POST['teacher_id']) ? intval($_POST['teacher_id']) : 0;
    $day_of_week = trim($_POST['day_of_week'] ?? '');
    $time_in = trim($_POST['time_in'] ?? '');
    $time_out = trim($_POST['time_out'] ?? '');
    $room = trim($_POST['room'] ?? '');
    
    // Validation
    if (empty($subject_name) || empty($grade_level)) {
        echo json_encode(['success' => false, 'error' => 'Subject name and grade level are required']);
        return;
    }
    
    // Format grade level with "Grade " prefix if not already
    if (!preg_match('/^Grade\s/', $grade_level)) {
        $grade_level = 'Grade ' . $grade_level;
    }
    
    // Check for schedule conflict
    if ($teacher_id && $day_of_week && $time_in && $time_out) {
        $conflict = checkConflictInternal($teacher_id, $day_of_week, $time_in, $time_out, null);
        if ($conflict) {
            echo json_encode(['success' => false, 'error' => 'Schedule conflict detected', 'conflict' => $conflict]);
            return;
        }
    }
    
    $stmt = $conn->prepare("INSERT INTO curriculum (subject_code, subject_name, grade_level, section, teacher_id, day_of_week, time_in, time_out, room) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
    
    if (!$stmt) {
        echo json_encode(['success' => false, 'error' => 'Prepare error: ' . $conn->error]);
        return;
    }
    
    // Bind parameters: 4 strings, 1 int, 4 strings
    if (!$stmt->bind_param('ssssissss', $subject_code, $subject_name, $grade_level, $section, $teacher_id, $day_of_week, $time_in, $time_out, $room)) {
        echo json_encode(['success' => false, 'error' => 'Bind error: ' . $stmt->error]);
        return;
    }
    
    if ($stmt->execute()) {
        $id = $conn->insert_id;
        echo json_encode(['success' => true, 'id' => $id, 'message' => 'Subject added successfully']);
    } else {
        echo json_encode(['success' => false, 'error' => 'Execute error: ' . $stmt->error]);
    }
    $stmt->close();
}

function updateCurriculum() {
    global $conn;
    ob_end_clean();
    
    $id = intval($_POST['id'] ?? 0);
    $subject_code = trim($_POST['subject_code'] ?? '');
    $subject_name = trim($_POST['subject_name'] ?? '');
    $grade_level = trim($_POST['grade_level'] ?? '');
    $section = trim($_POST['section'] ?? '');
    $teacher_id = !empty($_POST['teacher_id']) ? intval($_POST['teacher_id']) : 0;
    $day_of_week = trim($_POST['day_of_week'] ?? '');
    $time_in = trim($_POST['time_in'] ?? '');
    $time_out = trim($_POST['time_out'] ?? '');
    $room = trim($_POST['room'] ?? '');
    
    if (!$id) {
        echo json_encode(['success' => false, 'error' => 'Invalid ID']);
        return;
    }
    
    // Format grade level with "Grade " prefix if not already
    if (!preg_match('/^Grade\s/', $grade_level)) {
        $grade_level = 'Grade ' . $grade_level;
    }
    
    // Check for schedule conflict (exclude current record)
    if ($teacher_id && $day_of_week && $time_in && $time_out) {
        $conflict = checkConflictInternal($teacher_id, $day_of_week, $time_in, $time_out, $id);
        if ($conflict) {
            echo json_encode(['success' => false, 'error' => 'Schedule conflict detected', 'conflict' => $conflict]);
            return;
        }
    }
    
    $stmt = $conn->prepare("UPDATE curriculum SET subject_code = ?, subject_name = ?, grade_level = ?, section = ?, teacher_id = ?, day_of_week = ?, time_in = ?, time_out = ?, room = ? WHERE id = ?");
    
    if (!$stmt) {
        echo json_encode(['success' => false, 'error' => 'Prepare error: ' . $conn->error]);
        return;
    }
    
    // Bind parameters: 4 strings, 1 int, 4 strings, 1 int
    if (!$stmt->bind_param('ssssissssi', $subject_code, $subject_name, $grade_level, $section, $teacher_id, $day_of_week, $time_in, $time_out, $room, $id)) {
        echo json_encode(['success' => false, 'error' => 'Bind error: ' . $stmt->error]);
        return;
    }
    
    if ($stmt->execute()) {
        echo json_encode(['success' => true, 'message' => 'Subject updated successfully']);
    } else {
        echo json_encode(['success' => false, 'error' => 'Execute error: ' . $stmt->error]);
    }
    $stmt->close();
}

function deleteCurriculum() {
    global $conn;
    
    $id = intval($_POST['id'] ?? 0);
    
    if (!$id) {
        echo json_encode(['success' => false, 'error' => 'Invalid ID']);
        return;
    }
    
    $stmt = $conn->prepare("DELETE FROM curriculum WHERE id = ?");
    $stmt->bind_param('i', $id);
    
    if ($stmt->execute()) {
        echo json_encode(['success' => true, 'message' => 'Subject deleted successfully']);
    } else {
        echo json_encode(['success' => false, 'error' => $conn->error]);
    }
}

function getTeachers() {
    global $conn;
    
    $result = $conn->query("SELECT id, faculty_id, CONCAT(first_name, ' ', IFNULL(CONCAT(middle_initial, '. '), ''), last_name) as name, department FROM teachers WHERE status = 'Active' ORDER BY first_name, last_name");
    
    $teachers = [];
    while ($row = $result->fetch_assoc()) {
        $teachers[] = $row;
    }
    
    echo json_encode(['success' => true, 'teachers' => $teachers]);
}

function checkConflict() {
    $teacher_id = intval($_POST['teacher_id'] ?? 0);
    $day_of_week = trim($_POST['day_of_week'] ?? '');
    $time_in = trim($_POST['time_in'] ?? '');
    $time_out = trim($_POST['time_out'] ?? '');
    $exclude_id = intval($_POST['exclude_id'] ?? 0) ?: null;
    
    $conflict = checkConflictInternal($teacher_id, $day_of_week, $time_in, $time_out, $exclude_id);
    
    if ($conflict) {
        echo json_encode(['success' => false, 'conflict' => $conflict]);
    } else {
        echo json_encode(['success' => true, 'message' => 'No conflict']);
    }
}

function checkConflictInternal($teacher_id, $day_of_week, $time_in, $time_out, $exclude_id = null) {
    global $conn;
    
    if (!$teacher_id || !$day_of_week || !$time_in || !$time_out) {
        return null;
    }
    
    $sql = "SELECT c.*, CONCAT(c.subject_name, ' (', c.grade_level, ')') as conflict_subject
            FROM curriculum c
            WHERE c.teacher_id = ?
            AND c.day_of_week = ?
            AND c.time_in IS NOT NULL 
            AND c.time_out IS NOT NULL
            AND (
                (c.time_in < ? AND c.time_out > ?) OR
                (c.time_in < ? AND c.time_out > ?) OR
                (c.time_in >= ? AND c.time_out <= ?)
            )";
    
    if ($exclude_id) {
        $sql .= " AND c.id != ?";
    }
    
    $stmt = $conn->prepare($sql);
    
    if ($exclude_id) {
        $stmt->bind_param('issssssssi', $teacher_id, $day_of_week, $time_out, $time_in, $time_out, $time_in, $time_in, $time_out, $exclude_id);
    } else {
        $stmt->bind_param('issssssss', $teacher_id, $day_of_week, $time_out, $time_in, $time_out, $time_in, $time_in, $time_out);
    }
    
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($row = $result->fetch_assoc()) {
        return $row;
    }
    
    return null;
}
?>
